CREATE OR REPLACE TABLE FUNCTION `also-analytics-model-nonprod.2_NEGOCIO_S4.TF_CONTRATO_CONDICAO_MENSAL_4B` ()
       
AS 
WITH var_condicao_tempo AS (
    SELECT 
        COND.CSHP_CDSHOPPING,
        COND.BUKRS,
        COND.RECNNR,
        COND.SMIVE,
        COND.XMETXT,
        COND.SMENR,
        COND.INTRENO_VICNCN,
        COND.INTRENO,
        COND.DMIBEG,
        COND.DMIEND,
        TEMPO.CALMONTH,
        COND.CC_VALIDFROM	AS CONDVALIDFROM,
        COND.CC_VALIDTO 	AS CONDVALIDTO,
        COND.CALCRULE,
        COND.CONDTYPE,
        COND.CC_CONDVALUE	AS UNITPRICE,
        COND.CALCRULEPARA2
    FROM `also-analytics-model-nonprod.2_NEGOCIO_S4.TF_CONTRATO_CONDICAO_4B`() AS COND
    LEFT OUTER JOIN `also-analytics-model-nonprod.1_AQUISICAO_MXM.dim_tempo_mensal` AS TEMPO
        ON  LEFT(COND.CC_VALIDFROM, 6) <= TEMPO.CALMONTH
        AND LEFT(COND.CC_VALIDTO, 6) >= TEMPO.CALMONTH
    WHERE TEMPO.CALMONTH <= FORMAT_DATE('%Y%m', DATE_ADD(CURRENT_DATE(), INTERVAL 10 YEAR))
        AND COND.CSHP_CDSHOPPING IS NOT NULL
),

var_condicao_pivot AS (
    SELECT
        COND.CSHP_CDSHOPPING,
        COND.BUKRS,
        COND.RECNNR,
        COND.SMIVE,
        COND.XMETXT,
        COND.SMENR,
        COND.INTRENO_VICNCN,
        COND.INTRENO,
        COND.CALMONTH,
        COND.DMIBEG,
        COND.DMIEND,
        COND.CONDVALIDFROM,
        COND.CONDVALIDTO,
        COND.CALCRULE,
        CASE WHEN COND.CALCRULE IN ('E1') AND COND.CONDTYPE IN ('Z091')
--				THEN TO_DECIMAL(REPLACE(MAP(COND.CALCRULEPARA2,'','0',COND.CALCRULEPARA2), ',', '.')) 
            THEN REPLACE(IF((COND.CALCRULEPARA2 = ''), '0', COND.CALCRULEPARA2), ',', '.')
            ELSE COND.CALCRULEPARA2
        END AS CALCRULEPARA2,
        COND.CONDTYPE,
        CASE WHEN COND.CONDTYPE = 'Z001' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z001,
        CASE WHEN COND.CONDTYPE = 'Z004' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z004,
        CASE WHEN COND.CONDTYPE = 'Z007' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z007,
        CASE WHEN COND.CONDTYPE = 'Z010' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z010,
        CASE WHEN COND.CONDTYPE = 'Z013' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z013,
        CASE WHEN COND.CONDTYPE = 'Z016' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z016,
        CASE WHEN COND.CONDTYPE = 'Z019' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z019,
        CASE WHEN COND.CONDTYPE = 'Z022' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z022,
        CASE WHEN COND.CONDTYPE = 'Z025' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z025,
        CASE WHEN COND.CONDTYPE = 'Z028' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z028,
        CASE WHEN COND.CONDTYPE = 'Z031' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z031,
        CASE WHEN COND.CONDTYPE = 'Z034' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z034,
        CASE WHEN COND.CONDTYPE = 'Z037' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z037,
        CASE WHEN COND.CONDTYPE = 'Z040' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z040,
        CASE WHEN COND.CONDTYPE = 'Z043' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z043,
        CASE WHEN COND.CONDTYPE = 'Z046' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z046,
        CASE WHEN COND.CONDTYPE = 'Z049' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z049,
        CASE WHEN COND.CONDTYPE = 'Z052' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z052,
        CASE WHEN COND.CONDTYPE = 'Z055' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z055,
        CASE WHEN COND.CONDTYPE = 'Z058' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z058,
        CASE WHEN COND.CONDTYPE = 'Z061' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z061,
        CASE WHEN COND.CONDTYPE = 'Z064' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z064,
        CASE WHEN COND.CONDTYPE = 'Z067' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z067,
        CASE WHEN COND.CONDTYPE = 'Z070' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z070,
        CASE WHEN COND.CONDTYPE = 'Z073' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z073,
        CASE WHEN COND.CONDTYPE = 'Z076' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z076,
        CASE WHEN COND.CONDTYPE = 'Z079' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z079,
        CASE WHEN COND.CONDTYPE = 'Z082' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z082,
        CASE WHEN COND.CONDTYPE = 'Z085' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z085,
        CASE WHEN COND.CONDTYPE = 'Z088' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z088,
        CASE WHEN COND.CONDTYPE = 'Z091' 
                AND COND.CALCRULE <> 'E1'  THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z091,
        CASE WHEN COND.CONDTYPE = 'Z094' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z094,
        CASE WHEN COND.CONDTYPE = 'Z097' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z097,
        CASE WHEN COND.CONDTYPE = 'Z100' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z100,
        CASE WHEN COND.CONDTYPE = 'Z103' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z103,
        CASE WHEN COND.CONDTYPE = 'Z201' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z201,
        CASE WHEN COND.CONDTYPE = 'Z204' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z204,
        CASE WHEN COND.CONDTYPE = 'Z207' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z207,
        CASE WHEN COND.CONDTYPE = 'Z210' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z210,
        CASE WHEN COND.CONDTYPE = 'Z213' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z213,
        CASE WHEN COND.CONDTYPE = 'Z216' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z216,
        CASE WHEN COND.CONDTYPE = 'Z219' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z219,
        CASE WHEN COND.CONDTYPE = 'Z222' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z222,
        CASE WHEN COND.CONDTYPE = 'Z225' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z225,
        CASE WHEN COND.CONDTYPE = 'Z228' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z228,
        CASE WHEN COND.CONDTYPE = 'Z231' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z231,
        CASE WHEN COND.CONDTYPE = 'Z234' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z234,
        CASE WHEN COND.CONDTYPE = 'Z237' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z237,
        CASE WHEN COND.CONDTYPE = 'Z240' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z240,
        CASE WHEN COND.CONDTYPE = 'Z301' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z301,
        CASE WHEN COND.CONDTYPE = 'Z304' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z304,
        CASE WHEN COND.CONDTYPE = 'Z307' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z307,
        CASE WHEN COND.CONDTYPE = 'Z310' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z310,
        CASE WHEN COND.CONDTYPE = 'Z313' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z313,
        CASE WHEN COND.CONDTYPE = 'Z401' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z401,
        CASE WHEN COND.CONDTYPE = 'Z404' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z404,
        CASE WHEN COND.CONDTYPE = 'Z407' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z407,
        CASE WHEN COND.CONDTYPE = 'Z410' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z410,
        CASE WHEN COND.CONDTYPE = 'Z413' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z413,
        CASE WHEN COND.CONDTYPE = 'Z416' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z416,
        CASE WHEN COND.CONDTYPE = 'Z501' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z501,
        CASE WHEN COND.CONDTYPE = 'Z504' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z504,
        CASE WHEN COND.CONDTYPE = 'Z507' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z507,
        CASE WHEN COND.CONDTYPE = 'Z510' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z510,
        CASE WHEN COND.CONDTYPE = 'Z513' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z513,
        CASE WHEN COND.CONDTYPE = 'Z516' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z516,
        CASE WHEN COND.CONDTYPE = 'Z519' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z519,
        CASE WHEN COND.CONDTYPE = 'Z522' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z522,
        CASE WHEN COND.CONDTYPE = 'Z525' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z525,
        CASE WHEN COND.CONDTYPE = 'Z528' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z528,
        CASE WHEN COND.CONDTYPE = 'Z531' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z531,
        CASE WHEN COND.CONDTYPE = 'Z534' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z534,
        CASE WHEN COND.CONDTYPE = 'Z537' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z537,
        CASE WHEN COND.CONDTYPE = 'Z540' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z540,
        CASE WHEN COND.CONDTYPE = 'Z543' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z543,
        CASE WHEN COND.CONDTYPE = 'Z546' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z546,
        CASE WHEN COND.CONDTYPE = 'Z549' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z549,
        CASE WHEN COND.CONDTYPE = 'Z552' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z552,
        CASE WHEN COND.CONDTYPE = 'Z601' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z601,
        CASE WHEN COND.CONDTYPE = 'Z604' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z604,
        CASE WHEN COND.CONDTYPE = 'Z607' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z607,
        CASE WHEN COND.CONDTYPE = 'Z900' THEN COND.UNITPRICE ELSE 0 END AS UNITPRICE_Z900
    FROM var_condicao_tempo AS COND
),
			
var_saida1 AS ( 
    SELECT
        COND.CSHP_CDSHOPPING,
        COND.BUKRS,
        COND.RECNNR,
        COND.SMIVE,
        COND.XMETXT,
        COND.SMENR,
        COND.INTRENO_VICNCN,
        COND.INTRENO,
        COND.CALMONTH,
        COND.DMIBEG,
        COND.DMIEND,
        MAX(COND.UNITPRICE_Z001) AS UNITPRICE_Z001,
        MAX(COND.UNITPRICE_Z004) AS UNITPRICE_Z004,
        MAX(COND.UNITPRICE_Z007) AS UNITPRICE_Z007,
        MAX(COND.UNITPRICE_Z010) AS UNITPRICE_Z010,
        MAX(COND.UNITPRICE_Z013) AS UNITPRICE_Z013,
        MAX(COND.UNITPRICE_Z016) AS UNITPRICE_Z016,
        MAX(COND.UNITPRICE_Z019) AS UNITPRICE_Z019,
        MAX(COND.UNITPRICE_Z022) AS UNITPRICE_Z022,
        MAX(COND.UNITPRICE_Z025) AS UNITPRICE_Z025,
        MAX(COND.UNITPRICE_Z028) AS UNITPRICE_Z028,
        MAX(COND.UNITPRICE_Z031) AS UNITPRICE_Z031,
        MAX(COND.UNITPRICE_Z034) AS UNITPRICE_Z034,
        MAX(COND.UNITPRICE_Z037) AS UNITPRICE_Z037,
        MAX(COND.UNITPRICE_Z040) AS UNITPRICE_Z040,
        MAX(COND.UNITPRICE_Z043) AS UNITPRICE_Z043,
        MAX(COND.UNITPRICE_Z046) AS UNITPRICE_Z046,
        MAX(COND.UNITPRICE_Z049) AS UNITPRICE_Z049,
        MAX(COND.UNITPRICE_Z052) AS UNITPRICE_Z052,
        MAX(COND.UNITPRICE_Z055) AS UNITPRICE_Z055,
        MAX(COND.UNITPRICE_Z058) AS UNITPRICE_Z058,
        MAX(COND.UNITPRICE_Z061) AS UNITPRICE_Z061,
        MAX(COND.UNITPRICE_Z064) AS UNITPRICE_Z064,
        MAX(COND.UNITPRICE_Z067) AS UNITPRICE_Z067,
        MAX(COND.UNITPRICE_Z070) AS UNITPRICE_Z070,
        MAX(COND.UNITPRICE_Z073) AS UNITPRICE_Z073,
        MAX(COND.UNITPRICE_Z076) AS UNITPRICE_Z076,
        MAX(COND.UNITPRICE_Z079) AS UNITPRICE_Z079,
        MAX(COND.UNITPRICE_Z082) AS UNITPRICE_Z082,
        MAX(COND.UNITPRICE_Z085) AS UNITPRICE_Z085,
        MAX(COND.UNITPRICE_Z088) AS UNITPRICE_Z088,
        MAX(COND.UNITPRICE_Z091) AS UNITPRICE_Z091,
        MAX(COND.UNITPRICE_Z094) AS UNITPRICE_Z094,
        MAX(COND.UNITPRICE_Z097) AS UNITPRICE_Z097,
        MAX(COND.UNITPRICE_Z100) AS UNITPRICE_Z100,
        MAX(COND.UNITPRICE_Z103) AS UNITPRICE_Z103,
        MAX(COND.UNITPRICE_Z201) AS UNITPRICE_Z201,
        MAX(COND.UNITPRICE_Z204) AS UNITPRICE_Z204,
        MAX(COND.UNITPRICE_Z207) AS UNITPRICE_Z207,
        MAX(COND.UNITPRICE_Z210) AS UNITPRICE_Z210,
        MAX(COND.UNITPRICE_Z213) AS UNITPRICE_Z213,
        MAX(COND.UNITPRICE_Z216) AS UNITPRICE_Z216,
        MAX(COND.UNITPRICE_Z219) AS UNITPRICE_Z219,
        MAX(COND.UNITPRICE_Z222) AS UNITPRICE_Z222,
        MAX(COND.UNITPRICE_Z225) AS UNITPRICE_Z225,
        MAX(COND.UNITPRICE_Z228) AS UNITPRICE_Z228,
        MAX(COND.UNITPRICE_Z231) AS UNITPRICE_Z231,
        MAX(COND.UNITPRICE_Z234) AS UNITPRICE_Z234,
        MAX(COND.UNITPRICE_Z237) AS UNITPRICE_Z237,
        MAX(COND.UNITPRICE_Z240) AS UNITPRICE_Z240,
        MAX(COND.UNITPRICE_Z301) AS UNITPRICE_Z301,
        MAX(COND.UNITPRICE_Z304) AS UNITPRICE_Z304,
        MAX(COND.UNITPRICE_Z307) AS UNITPRICE_Z307,
        MAX(COND.UNITPRICE_Z310) AS UNITPRICE_Z310,
        MAX(COND.UNITPRICE_Z313) AS UNITPRICE_Z313,
        MAX(COND.UNITPRICE_Z401) AS UNITPRICE_Z401,
        MAX(COND.UNITPRICE_Z404) AS UNITPRICE_Z404,
        MAX(COND.UNITPRICE_Z407) AS UNITPRICE_Z407,
        MAX(COND.UNITPRICE_Z410) AS UNITPRICE_Z410,
        MAX(COND.UNITPRICE_Z413) AS UNITPRICE_Z413,
        MAX(COND.UNITPRICE_Z416) AS UNITPRICE_Z416,
        MAX(COND.UNITPRICE_Z501) AS UNITPRICE_Z501,
        MAX(COND.UNITPRICE_Z504) AS UNITPRICE_Z504,
        MAX(COND.UNITPRICE_Z507) AS UNITPRICE_Z507,
        MAX(COND.UNITPRICE_Z510) AS UNITPRICE_Z510,
        MAX(COND.UNITPRICE_Z513) AS UNITPRICE_Z513,
        MAX(COND.UNITPRICE_Z516) AS UNITPRICE_Z516,
        MAX(COND.UNITPRICE_Z519) AS UNITPRICE_Z519,
        MAX(COND.UNITPRICE_Z522) AS UNITPRICE_Z522,
        MAX(COND.UNITPRICE_Z525) AS UNITPRICE_Z525,
        MAX(COND.UNITPRICE_Z528) AS UNITPRICE_Z528,
        MAX(COND.UNITPRICE_Z531) AS UNITPRICE_Z531,
        MAX(COND.UNITPRICE_Z534) AS UNITPRICE_Z534,
        MAX(COND.UNITPRICE_Z537) AS UNITPRICE_Z537,
        MAX(COND.UNITPRICE_Z540) AS UNITPRICE_Z540,
        MAX(COND.UNITPRICE_Z543) AS UNITPRICE_Z543,
        MAX(COND.UNITPRICE_Z546) AS UNITPRICE_Z546,
        MAX(COND.UNITPRICE_Z549) AS UNITPRICE_Z549,
        MAX(COND.UNITPRICE_Z552) AS UNITPRICE_Z552,
        MAX(COND.UNITPRICE_Z601) AS UNITPRICE_Z601,
        MAX(COND.UNITPRICE_Z604) AS UNITPRICE_Z604,
        MAX(COND.UNITPRICE_Z607) AS UNITPRICE_Z607,
        MAX(COND.UNITPRICE_Z900) AS UNITPRICE_Z900,
        MAX(UNIDADE.FQMFLART)	 AS FQMFLART
    FROM var_condicao_pivot AS COND
    LEFT OUTER JOIN `also-analytics-model-nonprod.3_MATERIALIZADO_S4.DIM_UNIDADE_HIST` AS UNIDADE
        ON  COND.INTRENO  = UNIDADE.INTRENO_VICNCN
        AND COND.CALMONTH = UNIDADE.CALMONTH
    WHERE COND.CALCRULE <> 'E1'
    GROUP BY
        COND.CSHP_CDSHOPPING,
        COND.BUKRS,
        COND.RECNNR,
        COND.SMIVE,
        COND.XMETXT,
        COND.SMENR,
        COND.INTRENO_VICNCN,
        COND.INTRENO,
        COND.CALMONTH,
        COND.DMIBEG,
        COND.DMIEND
    ORDER BY 
        COND.RECNNR,
        COND.INTRENO,
        COND.CALMONTH
),

var_fpp AS (
    SELECT 
        INTRENO_VICNCN,
        CALMONTH,
        ROUND(SUM(UNITPRICE_Z091), 2) AS UNITPRICE_Z091
    FROM (
        SELECT
            COND.INTRENO_VICNCN,
            COND.CALMONTH,
            CASE WHEN COND.CALCRULE = 'E1' 
                THEN S1.UNITPRICE_Z010 * (CAST(COND.CALCRULEPARA2 AS INT64) / 100) 
                ELSE 0
            END AS UNITPRICE_Z091
        FROM var_condicao_pivot AS COND
        LEFT OUTER JOIN var_saida1 AS S1
            ON  S1.INTRENO_VICNCN = COND.INTRENO_VICNCN
            AND S1.CALMONTH       = COND.CALMONTH
        WHERE COND.CALCRULE = 'E1'
            AND COND.CONDTYPE = 'Z091')
    GROUP BY 
        INTRENO_VICNCN,
        CALMONTH
),
        
var_saida2 AS (
    SELECT
        S1.CSHP_CDSHOPPING,
        S1.BUKRS,
        S1.RECNNR,
        S1.SMIVE,
        S1.XMETXT,
        S1.SMENR,
        S1.INTRENO_VICNCN,
        S1.INTRENO,
        S1.CALMONTH,
        S1.DMIBEG,
        S1.DMIEND,
        S1.UNITPRICE_Z001,
        S1.UNITPRICE_Z004,
        S1.UNITPRICE_Z007,
        S1.UNITPRICE_Z010,
        S1.UNITPRICE_Z013,
        S1.UNITPRICE_Z016,
        S1.UNITPRICE_Z019,
        S1.UNITPRICE_Z022,
        S1.UNITPRICE_Z025,
        S1.UNITPRICE_Z028,
        S1.UNITPRICE_Z031,
        S1.UNITPRICE_Z034,
        S1.UNITPRICE_Z037,
        S1.UNITPRICE_Z040,
        S1.UNITPRICE_Z043,
        S1.UNITPRICE_Z046,
        S1.UNITPRICE_Z049,
        S1.UNITPRICE_Z052,
        S1.UNITPRICE_Z055,
        S1.UNITPRICE_Z058,
        S1.UNITPRICE_Z061,
        S1.UNITPRICE_Z064,
        S1.UNITPRICE_Z067,
        S1.UNITPRICE_Z070,
        S1.UNITPRICE_Z073,
        S1.UNITPRICE_Z076,
        S1.UNITPRICE_Z079,
        S1.UNITPRICE_Z082,
        S1.UNITPRICE_Z085,
        S1.UNITPRICE_Z088,
        S1.UNITPRICE_Z091,
        S1.UNITPRICE_Z094,
        S1.UNITPRICE_Z097,
        S1.UNITPRICE_Z100,
        S1.UNITPRICE_Z103,
        S1.UNITPRICE_Z201,
        S1.UNITPRICE_Z204,
        S1.UNITPRICE_Z207,
        S1.UNITPRICE_Z210,
        S1.UNITPRICE_Z213,
        S1.UNITPRICE_Z216,
        S1.UNITPRICE_Z219,
        S1.UNITPRICE_Z222,
        S1.UNITPRICE_Z225,
        S1.UNITPRICE_Z228,
        S1.UNITPRICE_Z231,
        S1.UNITPRICE_Z234,
        S1.UNITPRICE_Z237,
        S1.UNITPRICE_Z240,
        S1.UNITPRICE_Z301,
        S1.UNITPRICE_Z304,
        S1.UNITPRICE_Z307,
        S1.UNITPRICE_Z310,
        S1.UNITPRICE_Z313,
        S1.UNITPRICE_Z401,
        S1.UNITPRICE_Z404,
        S1.UNITPRICE_Z407,
        S1.UNITPRICE_Z410,
        S1.UNITPRICE_Z413,
        S1.UNITPRICE_Z416,
        S1.UNITPRICE_Z501,
        S1.UNITPRICE_Z504,
        S1.UNITPRICE_Z507,
        S1.UNITPRICE_Z510,
        S1.UNITPRICE_Z513,
        S1.UNITPRICE_Z516,
        S1.UNITPRICE_Z519,
        S1.UNITPRICE_Z522,
        S1.UNITPRICE_Z525,
        S1.UNITPRICE_Z528,
        S1.UNITPRICE_Z531,
        S1.UNITPRICE_Z534,
        S1.UNITPRICE_Z537,
        S1.UNITPRICE_Z540,
        S1.UNITPRICE_Z543,
        S1.UNITPRICE_Z546,
        S1.UNITPRICE_Z549,
        S1.UNITPRICE_Z552,
        S1.UNITPRICE_Z601,
        S1.UNITPRICE_Z604,
        S1.UNITPRICE_Z607,
        S1.UNITPRICE_Z900,
        S1.FQMFLART,
        S1.UNITPRICE_Z210 +
        S1.UNITPRICE_Z213 +
        S1.UNITPRICE_Z010 +
        S1.UNITPRICE_Z201 +
        S1.UNITPRICE_Z207					AS CC_AM,
        S1.UNITPRICE_Z013					AS CC_AA,
        0										AS CC_DIF,
        S1.UNITPRICE_Z401					AS CC_ESTACAM,
        S1.UNITPRICE_Z407					AS CC_ESTACAC,
        S1.UNITPRICE_Z604 +
        S1.UNITPRICE_Z016 +
        S1.UNITPRICE_Z219					AS CC_AC,
        S1.UNITPRICE_Z079 +
        S1.UNITPRICE_Z900 +
        S1.UNITPRICE_Z073 
    /* + S1.UNITPRICE_Z074*/ 				AS CC_EC,
        S1.UNITPRICE_Z540					AS CC_EE,
        IFNULL(FPP.UNITPRICE_Z091, 0) +
        S1.UNITPRICE_Z091             +
        S1.UNITPRICE_Z237					AS CC_FP,
        0										AS CC_PE
    FROM var_saida1 AS S1
    LEFT OUTER JOIN var_fpp AS FPP
        ON  FPP.INTRENO_VICNCN = S1.INTRENO_VICNCN
        AND FPP.CALMONTH       = S1.CALMONTH
)
        
    SELECT
        CSHP_CDSHOPPING,
        BUKRS,
        RECNNR,
        SMIVE,
        XMETXT,
        SMENR,
        INTRENO_VICNCN,
        INTRENO,
        CALMONTH,
        DMIBEG,
        DMIEND,
        UNITPRICE_Z001,
        UNITPRICE_Z004,
        UNITPRICE_Z007,
        UNITPRICE_Z010,
        UNITPRICE_Z013,
        UNITPRICE_Z016,
        UNITPRICE_Z019,
        UNITPRICE_Z022,
        UNITPRICE_Z025,
        UNITPRICE_Z028,
        UNITPRICE_Z031,
        UNITPRICE_Z034,
        UNITPRICE_Z037,
        UNITPRICE_Z040,
        UNITPRICE_Z043,
        UNITPRICE_Z046,
        UNITPRICE_Z049,
        UNITPRICE_Z052,
        UNITPRICE_Z055,
        UNITPRICE_Z058,
        UNITPRICE_Z061,
        UNITPRICE_Z064,
        UNITPRICE_Z067,
        UNITPRICE_Z070,
        UNITPRICE_Z073,
        UNITPRICE_Z076,
        UNITPRICE_Z079,
        UNITPRICE_Z082,
        UNITPRICE_Z085,
        UNITPRICE_Z088,
        UNITPRICE_Z091,
        UNITPRICE_Z094,
        UNITPRICE_Z097,
        UNITPRICE_Z100,
        UNITPRICE_Z103,
        UNITPRICE_Z201,
        UNITPRICE_Z204,
        UNITPRICE_Z207,
        UNITPRICE_Z210,
        UNITPRICE_Z213,
        UNITPRICE_Z216,
        UNITPRICE_Z219,
        UNITPRICE_Z222,
        UNITPRICE_Z225,
        UNITPRICE_Z228,
        UNITPRICE_Z231,
        UNITPRICE_Z234,
        UNITPRICE_Z237,
        UNITPRICE_Z240,
        UNITPRICE_Z301,
        UNITPRICE_Z304,
        UNITPRICE_Z307,
        UNITPRICE_Z310,
        UNITPRICE_Z313,
        UNITPRICE_Z401,
        UNITPRICE_Z404,
        UNITPRICE_Z407,
        UNITPRICE_Z410,
        UNITPRICE_Z413,
        UNITPRICE_Z416,
        UNITPRICE_Z501,
        UNITPRICE_Z504,
        UNITPRICE_Z507,
        UNITPRICE_Z510,
        UNITPRICE_Z513,
        UNITPRICE_Z516,
        UNITPRICE_Z519,
        UNITPRICE_Z522,
        UNITPRICE_Z525,
        UNITPRICE_Z528,
        UNITPRICE_Z531,
        UNITPRICE_Z534,
        UNITPRICE_Z537,
        UNITPRICE_Z540,
        UNITPRICE_Z543,
        UNITPRICE_Z546,
        UNITPRICE_Z549,
        UNITPRICE_Z552,
        UNITPRICE_Z601,
        UNITPRICE_Z604,
        UNITPRICE_Z607,
        UNITPRICE_Z900,
        FQMFLART,
        CC_AM,
        CC_AA,
        CC_DIF,
        CC_ESTACAM,
        CC_ESTACAC,
        CC_AC,
        CC_EC,
        CC_EE,
        CC_FP,
        CC_PE,
        CASE WHEN FQMFLART > 0 THEN CC_AM		ELSE 0 END AS CC_AM_COM_FQMFLART,
        CASE WHEN FQMFLART > 0 THEN CC_AA		ELSE 0 END AS CC_AA_COM_FQMFLART,
        CASE WHEN FQMFLART > 0 THEN CC_ESTACAM	ELSE 0 END AS CC_ESTACAM_COM_FQMFLART,
        CASE WHEN FQMFLART > 0 THEN CC_ESTACAC	ELSE 0 END AS CC_ESTACAC_COM_FQMFLART,
        CASE WHEN FQMFLART > 0 THEN CC_AC		ELSE 0 END AS CC_AC_COM_FQMFLART,
        CASE WHEN FQMFLART > 0 THEN CC_EC		ELSE 0 END AS CC_EC_COM_FQMFLART,
        CASE WHEN FQMFLART > 0 THEN CC_EE		ELSE 0 END AS CC_EE_COM_FQMFLART,
        CASE WHEN FQMFLART > 0 THEN CC_FP		ELSE 0 END AS CC_FP_COM_FQMFLART,
        CASE WHEN CC_AM	   > 0 THEN FQMFLART	ELSE 0 END AS CC_FQMFLART_COM_AM,
        CASE WHEN CC_AA	   > 0 THEN FQMFLART	ELSE 0 END AS CC_FQMFLART_COM_AA,
        CASE WHEN CC_ESTACAM > 0 THEN FQMFLART	ELSE 0 END AS CC_FQMFLART_COM_ESTACAM,
        CASE WHEN CC_ESTACAC > 0 THEN FQMFLART	ELSE 0 END AS CC_FQMFLART_COM_ESTACAC,
        CASE WHEN CC_AC	   > 0 THEN FQMFLART	ELSE 0 END AS CC_FQMFLART_COM_AC,
        CASE WHEN CC_EC	   > 0 THEN FQMFLART	ELSE 0 END AS CC_FQMFLART_COM_EC,
        CASE WHEN CC_EE	   > 0 THEN FQMFLART	ELSE 0 END AS CC_FQMFLART_COM_EE,
        CASE WHEN CC_FP	   > 0 THEN FQMFLART	ELSE 0 END AS CC_FQMFLART_COM_FP
    FROM var_saida2